import{p as X}from"../dompurify/dompurify.js";import{m as Y}from"../marked/marked.js";import{d as z,r as v,W as Z,c as E,J as ee,o as _,I as te,a as d,Q as ne,M as oe,at as ae,j as se,k as le,w as re,ay as ie,P as x,H as f,ag as U,O,a6 as H,L as T,G as K,n as ce}from"../@vue/@vue.js";import{_ as F}from"../../index.DJwNFrtO.js";import"../pinia/pinia.js";import"../vue-router/vue-router.js";import"../element-plus/element-plus.js";import"../lodash-es/lodash-es.js";import"../@vueuse/@vueuse.js";import"../@element-plus/@element-plus.js";import"../@popperjs/@popperjs.js";import"../@ctrl/@ctrl.js";import"../dayjs/dayjs.js";import"../async-validator/async-validator.js";import"../memoize-one/memoize-one.js";import"../normalize-wheel-es/normalize-wheel-es.js";import"../@floating-ui/@floating-ui.js";const ue={key:0,class:"loading-overlay"},de=z({__name:"index",setup(n,{expose:t}){const e=v(!1),o=v(""),s=v(!1),l=v(),r=v(0),u=m=>{o.value=m,e.value=!0,s.value=!1,r.value=Date.now(),l.value=setTimeout(()=>{s.value=!0},5e3)},k=()=>{const m=Date.now()-r.value,h=Math.max(300-m,0);setTimeout(()=>{b()},h)},b=()=>{clearTimeout(l.value),s.value=!1,e.value=!1};return Z(b),t({open:u,close:b}),(m,h)=>e.value?(_(),E("div",ue,[te(d("div",{class:"close-button",onClick:k,title:"关闭"},null,512),[[ne,s.value]]),h[0]||(h[0]=d("div",{class:"loading-spinner"},null,-1)),d("p",null,oe(o.value),1)])):ee("",!0)}}),ve=F(de,[["__scopeId","data-v-768d3707"]]);let y=null,V=null,w=null,M=0,C=null;const pe=()=>({open:(e="加载中...")=>{C&&(clearTimeout(C),C=null),y||(w=document.createElement("div"),document.body.appendChild(w),V=ae(ve),y=V.mount(w)),M=Date.now(),y?.open(e)},close:()=>{if(!y)return;const e=Date.now()-M,o=Math.max(300-e,0);C=setTimeout(()=>{y.close(),V?.unmount(),w&&document.body.contains(w)&&document.body.removeChild(w),V=null,y=null,w=null,C=null},o)}}),{open:me,close:fe}=pe(),I="http://k-rpa-lite.kingsware.cn:48080",W=["https://k-rpa-lite.donxj.com"],we=15e3;let L=I,B=0;const be=10*60*1e3;let D=null;class q extends Error{constructor(t){super(t),this.name="NetworkError"}}class R extends Error{statusCode;constructor(t,e){super(e),this.name="HttpError",this.statusCode=t}}class he extends Error{constructor(){super("Request timeout"),this.name="TimeoutError"}}function ge(){return[I,...W]}const S=async n=>{const t=new AbortController,e=setTimeout(()=>t.abort(),5e3);try{return(await fetch(`${n}/config.json`,{method:"HEAD",signal:t.signal,cache:"no-cache"})).ok}catch{return!1}finally{clearTimeout(e)}},ye=async()=>{if(await S(I))return I;for(const n of W)if(await S(n))return n;throw new q("请求地址不可用")};async function G(){return Date.now()-B>be||!L?(D||(D=(async()=>{try{const t=await ye();return L=t,B=Date.now(),t}finally{D=null}})()),D):L}const j=async(n,t="json",e=2)=>{const o=new AbortController,s=setTimeout(()=>o.abort(),we);try{const r=`${await G()}${n}`,u=await fetch(r,{signal:o.signal,cache:"no-cache"});if(clearTimeout(s),!u.ok)throw new R(u.status,`请求失败，状态码：${u.status}`);return await u[t]()}catch(l){if(clearTimeout(s),e>0){const r=ge(),u=r.indexOf(L),k=u>=0?(u+1)%r.length:0;return L=r[k],j(n,t,e-1)}throw l instanceof R?l:l.name==="AbortError"?new he:new q(`网络请求失败: ${l.message}`)}},_e=async()=>await j("/config.json?t="+Date.now()),ke=async n=>await j(n,"text"),$=async(n,t="",e=1)=>{try{me();const s=`${await G()}${n}`,l=await fetch(s);if(!l.ok)throw new R(l.status,"文件下载失败");const r=await l.blob();await xe(r,`K-RPA Lite${t}`)}catch(o){if(e>0)return B=0,$(n,t,e-1);throw o}finally{fe()}};async function xe(n,t="下载文件"){try{const{showSaveFilePicker:e}=window;if(e){const s=await(await e({types:[{description:"All Files",accept:{"*/*":[]}}],suggestedName:t})).createWritable();await s.write(await n.arrayBuffer()),await s.close()}else{const o=window.URL.createObjectURL(n),s=document.createElement("a");s.href=o,s.target="_blank",s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(o)}}catch(e){console.error("文件保存失败:",e)}}function Ce(n,t){const e=n.split(".").map(Number),o=t.split(".").map(Number),s=Math.max(e.length,o.length);for(let l=0;l<s;l++){const r=l<e.length?e[l]:0,u=l<o.length?o[l]:0;if(r>u)return 1;if(r<u)return-1}return 0}function Le(n,t){if(!n||n.length===0)return{};let e=n[0];for(let o=1;o<n.length;o++)Ce(n[o][t],e[t])>0&&(e=n[o]);return e}const Ae={class:"update-about"},Ue={class:"main"},Te={class:"box"},Ve={class:"version"},De={class:"select"},Ee={class:"select"},Ie={class:"remark"},Pe=["innerHTML"],Be=z({__name:"index",setup(n){const t=v(""),e=v(""),o=v(),s=v([]),l=v([]),r=v({}),u=v(""),k=async()=>{r.value=await _e();const c=Object.keys(r.value);c.length!==0&&(s.value=c.map(a=>({value:a,label:a})),t.value=c[0])},b=async()=>{await ce();const c=await ke(`/${t.value}/${e.value}/changeLog.md`),a=await Y.parse(c),p=X.sanitize(a);u.value=p};se(async()=>{k()});const m=le(()=>!!(t.value&&e.value)),h=()=>{if(!m)return;const c="/"+t.value+"/"+e.value+"/K-RPA Lite.zip";$(c,e.value+".zip")},J=()=>{if(!m)return;const c="/plugin/"+o.value+".zip";$(c,o.value+".zip")},N=c=>{if(Object.keys(r.value).length===0)return;const p=[];for(let i in r.value)if(i===c){p.push(...r.value[i]);break}l.value=p.map(i=>({value:i.version,label:i.version,plugin:i.plugin}));const g=Le(l.value,"value"),{plugin:P,value:A}=g;e.value=A,o.value=P,b()},Q=c=>{const p=r.value[t.value]?.find(g=>g.version===c);p&&(e.value=p.version,o.value=p.plugin,b())};return re(t,c=>{c&&N(c)},{once:!0}),(c,a)=>{const p=U("el-option"),g=U("el-select"),P=U("el-scrollbar"),A=U("el-button");return _(),E("div",Ae,[d("div",Ue,[d("div",Te,[a[9]||(a[9]=d("div",{class:"title"},"下载 K-RPA Lite®",-1)),d("div",Ve,[a[4]||(a[4]=d("div",{class:"text"},"获取 K-RPA Lite®",-1)),d("div",De,[x(g,{modelValue:t.value,"onUpdate:modelValue":a[0]||(a[0]=i=>t.value=i),placeholder:"系统",style:{width:"100%"},onChange:N},{empty:f(()=>a[2]||(a[2]=[T("暂无系统")])),default:f(()=>[(_(!0),E(O,null,H(s.value,i=>(_(),K(p,{key:i.value,label:i.label,value:i.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),a[5]||(a[5]=d("div",{class:"text"},"环境中的",-1)),d("div",Ee,[x(g,{modelValue:e.value,"onUpdate:modelValue":a[1]||(a[1]=i=>e.value=i),placeholder:"版本",style:{width:"100%"},onChange:Q},{empty:f(()=>a[3]||(a[3]=[T("先选系统系统")])),default:f(()=>[(_(!0),E(O,null,H(l.value,i=>(_(),K(p,{key:i.value,label:i.label,value:i.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),a[6]||(a[6]=d("div",{class:"text"},"版本。",-1))]),d("div",Ie,[x(P,{height:"100%"},{default:f(()=>[d("div",{class:"content",innerHTML:u.value},null,8,Pe)]),_:1})]),x(A,{disabled:!m.value,type:"primary",class:"btn",onClick:h},{default:f(()=>a[7]||(a[7]=[T(" 下载 K-RPA Lite 至本地 ")])),_:1},8,["disabled"]),x(A,{disabled:!m.value,type:"primary",class:"btn",onClick:J},{default:f(()=>a[8]||(a[8]=[T("下载插件")])),_:1},8,["disabled"])])]),a[10]||(a[10]=ie('<div class="footer" data-v-b1f9594e><div class="left" data-v-b1f9594e><p data-v-b1f9594e>版权所有：©2025 金智维</p><p data-v-b1f9594e>粤ICP备16115221号-1</p></div><div class="right" data-v-b1f9594e><div class="policy" data-v-b1f9594e>商业策略</div><div class="line" data-v-b1f9594e></div><div class="policy" data-v-b1f9594e>隐私策略</div><div class="line" data-v-b1f9594e></div><div class="policy" data-v-b1f9594e>安全政策</div><div class="line" data-v-b1f9594e></div><div class="bgcImg" data-v-b1f9594e></div></div></div>',1))])}}}),Ye=F(Be,[["__scopeId","data-v-b1f9594e"]]);export{Ye as default};
